<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Travel Pro v16</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#1A1A1A', card: '#2A2F3A', textMain: '#FFFFFF', textSub: '#F5F5F5',
                        accentBlue: '#3A68FF', accentTeal: '#2CC8C8', accentGold: '#C9A86A',
                        vjw: '#FF5C8D',
                        border: 'rgba(255,255,255,0.1)', danger: '#EF4444', success: '#10B981', warning: '#F59E0B',
                        catFood: '#F87171', catDrink: '#60A5FA', catPlay: '#FBBF24', catShop: '#A78BFA'
                    },
                    fontFamily: {
                        sans: ['"SF Pro Text"', '"PingFang TC"', '-apple-system', 'sans-serif'],
                        mono: ['"SF Mono"', 'ui-monospace', 'monospace']
                    }
                }
            }
        }
    </script>

    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #111; font-family: -apple-system, "PingFang TC", sans-serif; -webkit-font-smoothing: antialiased; overscroll-behavior: none; touch-action: manipulation; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-panel { background: rgba(42, 47, 58, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #C9A86A; }
        .modal-enter-active, .modal-leave-active { transition: opacity 0.2s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .slide-in-left { animation: slideInLeft 0.3s ease-out; }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .progress-bar { transition: width 0.5s ease-in-out; }
        input[type="date"] { -webkit-appearance: none; appearance: none; display: block; min-height: 2.5rem; }
    </style>
</head>
<body class="flex justify-center w-full">

    <div id="app" class="w-full max-w-[480px] h-[100dvh] bg-bg flex flex-col relative shadow-2xl overflow-hidden text-textMain">
        
        <!-- Header -->
        <div class="relative shrink-0 h-[260px]">
            <div class="absolute inset-0 bg-cover bg-center z-0 transition-all duration-500" :style="{ backgroundImage: `url(${safeCurrentTrip.coverImage})` }">
                <div class="absolute inset-0 bg-gradient-to-b from-black/40 via-black/20 to-bg"></div>
            </div>
            
            <div class="relative z-10 flex flex-col h-full justify-between pb-4 pt-12 px-5">
                <div class="flex justify-between items-center">
                    <button @click="isDrawerOpen = true" class="w-10 h-10 rounded-full bg-black/30 backdrop-blur-md flex items-center justify-center border border-white/10 active:bg-accentGold transition"><i class="fas fa-bars text-lg"></i></button>
                    <button @click="openSettings" class="w-10 h-10 rounded-full bg-black/30 backdrop-blur-md flex items-center justify-center border border-white/10 active:bg-accentGold transition"><i class="fas fa-cog text-lg"></i></button>
                </div>

                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-accentGold text-bg text-[10px] font-bold px-1.5 py-0.5 rounded tracking-wider">TRIP</span>
                        <button @click="openSettings" class="flex items-center gap-2 group">
                            <span class="text-textSub text-sm font-medium font-mono group-active:text-accentGold transition">{{ safeCurrentTrip.startDate }}</span>
                            <i class="fas fa-pencil-alt text-xs text-white/50"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-end">
                        <h1 class="text-3xl font-bold tracking-tight shadow-sm line-clamp-1">{{ safeCurrentTrip.name }}</h1>
                        <button @click="showFlightPass = !showFlightPass" class="w-8 h-8 rounded-full bg-white/10 backdrop-blur flex items-center justify-center active:bg-accentBlue"><i class="fas fa-plane text-sm"></i></button>
                    </div>
                </div>

                <div v-if="viewMode === 'itinerary'" class="w-full overflow-x-auto no-scrollbar pb-1">
                    <div class="flex gap-2">
                        <button v-for="(day, idx) in safeCurrentTrip.days" :key="idx" @click="currentDayIndex = idx" class="flex-shrink-0 w-[60px] h-[50px] rounded-xl border border-white/10 flex flex-col items-center justify-center transition-all duration-200" :class="currentDayIndex === idx ? 'bg-white text-bg' : 'bg-black/40 text-textSub hover:bg-black/60'">
                            <span class="text-xs font-bold leading-none">D{{ idx + 1 }}</span>
                            <span class="text-[10px] font-mono opacity-80 mt-1 leading-none">{{ getDisplayDate(idx) }}</span>
                        </button>
                        <button @click="addNewDay" class="flex-shrink-0 w-[50px] h-[50px] rounded-xl border border-dashed border-white/30 flex items-center justify-center text-white/50 hover:text-accentGold hover:border-accentGold transition"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto bg-bg -mt-4 rounded-t-3xl relative z-20 pt-6 px-4 pb-28 no-scrollbar">
            
            <!-- 1. 行程視圖 -->
            <div v-if="viewMode === 'itinerary'" class="space-y-4">
                <!-- 機票卡片 -->
                <div v-if="showFlightPass && currentFlightData" class="bg-card rounded-2xl shadow-lg overflow-hidden mb-2 border border-white/10">
                    <div class="flex bg-black/30 border-b border-white/5">
                        <button @click="flightMode='outbound'" class="flex-1 py-1.5 text-[10px] font-bold tracking-wider text-center transition" :class="flightMode==='outbound'?'text-accentBlue bg-white/10':'text-textSub/30'">去程 OUTBOUND</button>
                        <button @click="flightMode='inbound'" class="flex-1 py-1.5 text-[10px] font-bold tracking-wider text-center transition" :class="flightMode==='inbound'?'text-accentBlue bg-white/10':'text-textSub/30'">回程 INBOUND</button>
                    </div>
                    <div class="p-3 bg-gradient-to-br from-[#2c3e50] to-[#1a252f]">
                        <div class="flex justify-between items-center mb-3">
                            <input v-model="currentFlightData.origin" @input="saveData" class="bg-transparent text-3xl font-bold w-20 text-left text-white placeholder-white/20 font-mono focus:bg-black/20 rounded px-1" placeholder="TPE">
                            <div class="flex flex-col items-center opacity-50"><i class="fas fa-plane text-white text-xs rotate-90"></i><div class="w-12 h-[1px] bg-white/50 my-1"></div></div>
                            <input v-model="currentFlightData.dest" @input="saveData" class="bg-transparent text-3xl font-bold w-20 text-right text-white placeholder-white/20 font-mono focus:bg-black/20 rounded px-1" placeholder="KIX">
                        </div>
                        <div class="grid grid-cols-4 gap-2 text-center bg-black/20 p-2 rounded-lg border border-white/5">
                            <div class="flex flex-col"><span class="text-[9px] text-accentBlue font-bold mb-0.5">FLIGHT</span><input v-model="currentFlightData.flightNo" @input="saveData" class="w-full bg-transparent text-xs font-bold text-white text-center font-mono placeholder-white/20" placeholder="--"></div>
                            <div class="flex flex-col"><span class="text-[9px] text-accentBlue font-bold mb-0.5">GATE</span><input v-model="currentFlightData.gate" @input="saveData" class="w-full bg-transparent text-xs font-bold text-white text-center font-mono placeholder-white/20" placeholder="--"></div>
                            <div class="flex flex-col"><span class="text-[9px] text-accentBlue font-bold mb-0.5">SEAT</span><input v-model="currentFlightData.seat" @input="saveData" class="w-full bg-transparent text-xs font-bold text-white text-center font-mono placeholder-white/20" placeholder="--"></div>
                            <div class="flex flex-col"><span class="text-[9px] text-accentBlue font-bold mb-0.5">TIME</span><input type="time" v-model="currentFlightData.time" @input="saveData" class="w-full bg-transparent text-xs font-bold text-white text-center font-mono placeholder-white/20"></div>
                        </div>
                        <a href="https://www.vjw.digital.go.jp/main/#/vjwpco001" target="_blank" class="mt-3 w-full bg-vjw hover:bg-pink-600 text-white py-2 rounded-lg flex items-center justify-center gap-2 text-xs font-bold transition shadow-lg"><i class="fas fa-qrcode"></i> Visit Japan Web 電子簽證</a>
                    </div>
                </div>

                <div v-if="sortedItinerary.length === 0" class="text-center text-white/30 py-10"><p class="text-sm">尚未安排行程，點擊右下角 + 新增</p></div>

                <div v-for="item in sortedItinerary" :key="item.id" class="flex gap-3 relative group">
                    <div class="w-12 pt-4 text-right shrink-0 font-mono text-sm font-bold text-accentGold">{{ item.time }}</div>
                    <div class="relative flex flex-col items-center">
                        <div class="w-3 h-3 rounded-full border-2 border-bg z-10 mt-5" :style="{ backgroundColor: getTypeConfig(item.type).color }"></div>
                        <div class="w-[1px] bg-white/10 flex-1 -mt-2 mb-[-10px]"></div>
                    </div>
                    <div class="flex-1 pb-4 min-w-0">
                        <div @click="openEditModal(item)" class="bg-card p-3 rounded-xl border border-white/5 active:scale-[0.98] transition cursor-pointer hover:border-accentGold/50">
                            <!-- 交通資訊 -->
                            <div v-if="item.transportLine || item.transportTime" class="mb-2 pb-2 border-b border-white/5 flex items-center gap-2">
                                <div class="bg-bg px-2 py-1 rounded text-[10px] text-textSub/70 border border-white/10 flex items-center gap-1"><i class="fas fa-train text-accentBlue"></i><span class="font-bold">{{ item.transportLine || '移動' }}</span></div>
                                <div class="text-[10px] text-textSub/40" v-if="item.transportTime">約 {{ item.transportTime }} 分鐘</div>
                                <div class="flex-1"></div><div class="text-[10px] text-accentGold font-bold">前往此處 <i class="fas fa-arrow-down ml-1"></i></div>
                            </div>
                            <!-- 一般資訊 -->
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-base truncate pr-2">{{ item.title }}</h3>
                                <button @click.stop="openGoogleMap(item.location || item.title)" class="shrink-0 flex items-center gap-1 bg-accentBlue/10 px-2 py-1 rounded text-[10px] font-bold text-accentBlue hover:bg-accentBlue hover:text-white transition"><i class="fas fa-map-marked-alt"></i> 地圖</button>
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-[10px] px-1.5 py-0.5 rounded bg-bg text-textSub/70 border border-white/5">{{ getTypeConfig(item.type).label }}</span>
                                <span class="text-xs text-textSub/50 truncate"><i class="fas fa-map-marker-alt text-[10px] mr-1"></i>{{ item.location }}</span>
                            </div>
                            <div v-if="item.notes" class="text-xs text-accentGold/80 bg-accentGold/10 p-2 rounded mt-2"><i class="far fa-sticky-note mr-1"></i>{{ item.notes }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 住宿 -->
            <div v-if="viewMode === 'accommodation'" class="space-y-4">
                <h2 class="text-xl font-bold text-accentGold mb-2 px-1">住宿管理</h2>
                <div v-for="hotel in safeCurrentTrip.accommodations" :key="hotel.id" class="bg-card p-
